<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Whoâ€™s the Gekon? â€“ Mobilna wersja</title>
  <link rel="stylesheet" href="/static/mobi.css" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div id="hostInfo" class="host-info"> Host: â€”</div>
  <div class="container">
    <h1>Whoâ€™s the Gekon?</h1>
    

    <div id="status">Oczekiwanie...</div>
    <div id="role"></div>
    <div id="timer"></div>

    <div class="btn-grid">
      <button id="joinBtn" class="game-btn orange">DoÅ‚Ä…cz do gry</button>
      <button id="startBtn" class="game-btn blue">Start gry</button>
      <button id="restartBtn" class="game-btn red">Restart/Koniec</button>
      <button id="nextBtn" class="game-btn green">NastÄ™pna runda</button>
    </div>

    <div class="big-btn">
      <button id="stopBtn" class="stop-button">DUÅ»Y PRZYCISK</button>
    </div>
    

<!-- PICKER NA DOLE KONTENERA -->
<div id="catPicker" class="cat-picker">
  <label for="timerSec">Czas:</label>
  <input id="timerSec" type="number" min="5" max="900" step="5" value="30" class="timer-input">
  <button id="applyTimer" class="game-btn deepb">OK</button>

  <button id="toggleCats" class="game-btn deepk">Kategorie </button>
  <div id="catList" class="cat-list hidden">
  {% for c in categories %}
    <label><input type="checkbox" name="catOpt" value="{{ c }}" checked> {{ c }}</label><br>
  {% endfor %}
</div>
</div>



</body>


  <script>

 
    const socket = io();
    document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("toggleCats");
  const catList   = document.getElementById("catList");
  if (toggleBtn && catList) {
    toggleBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      catList.classList.toggle("hidden");
    });
  }
});
    let myId = "";
    let chosenCats = [];
const $ = id => document.getElementById(id);
function getSelectedCats(){
  return Array.from(document.querySelectorAll('input[name="catOpt"]:checked'))
              .map(el => el.value);
}
document.getElementById("applyTimer").onclick = () => {
  const v = parseInt(document.getElementById("timerSec").value, 10);
  socket.emit("set_timer", { seconds: v }, (ack) => {
    console.log("[ACK] set_timer:", ack);
  });
};






function applyCategorySelection(list, labelText) {
  const set = new Set(list || []);
  document.querySelectorAll('input[name="catOpt"]').forEach(cb => {
    cb.checked = set.has(cb.value);
  });


  // pokaÅ¼ w statusie
  document.getElementById("status").textContent = `Kategoria: ${labelText || (list && list.join(", ")) || "Losowa"}`;
}
document.getElementById("catPicker").addEventListener("change", (e) => {
  if (e.target && e.target.name === "catOpt") {
    const cats = Array.from(document.querySelectorAll('input[name="catOpt"]:checked'))
                      .map(el => el.value);
    console.log('[UI] wybÃ³r kategorii ->', cats);
    // wyÅ›lij + oczekuj ACK z serwera
    socket.emit("set_category", { categories: cats }, (ack) => {
      console.log('[ACK] set_category:', ack);
    });
  }
});




// ---- POKAZYWANIE / CHOWANIE PRZYCISKÃ“W ----
function showBeforeStart() {
    document.getElementById("joinBtn").style.display    = "inline-block";
    document.getElementById("startBtn").style.display   = "inline-block";
    document.getElementById("restartBtn").style.display = "inline-block";
    document.getElementById("nextBtn").style.display    = "none";
    document.getElementById("stopBtn").style.display    = "none";
    $("catPicker").classList.remove("hidden");
    const catList = document.getElementById("catList");
  if (catList) catList.classList.add("hidden"); 

  }

  function showAfterStart() {
    document.getElementById("joinBtn").style.display    = "none";
    document.getElementById("startBtn").style.display   = "none";
    document.getElementById("restartBtn").style.display = "inline-block"; // jeÅ›li chcesz ukryÄ‡, zmieÅ„ na "none"
    document.getElementById("nextBtn").style.display    = "inline-block";
    document.getElementById("stopBtn").style.display    = "inline-block";
    $("catPicker").classList.add("hidden");
    const catList = document.getElementById("catList");
  if (catList) catList.classList.add("hidden"); 
  }

  // startowy ukÅ‚ad
  showBeforeStart();

  // ---- HANDLERY KLIKÃ“W ----
  document.getElementById("joinBtn").onclick = () => {
    const name = prompt("Podaj swoje imiÄ™:");
    if (!name || name.trim() === "") return alert("Musisz wpisaÄ‡ imiÄ™!");
    myId = name.trim();
    socket.emit("join", { id: myId });
  };

 document.getElementById("startBtn").onclick = () => {
  socket.emit("set_category", { categories: getSelectedCats() });
  socket.emit("start");
};


  document.getElementById("nextBtn").onclick = () => {
    socket.emit("next_round");
  };

  document.getElementById("restartBtn").onclick = () => {
    socket.emit("restart");
    // ukÅ‚ad przeÅ‚Ä…czy siÄ™ po "clear"/"Gra zresetowana"
  };

  document.getElementById("stopBtn").onclick = () => {
    if (!myId) return alert("Najpierw doÅ‚Ä…cz do gry!");
    socket.emit("pause", { id: myId });
  };


function applyCategorySelection(list, labelText) {
  // odhacz / zaznacz checkboxy
  const set = new Set(list || []);
  document.querySelectorAll('input[name="catOpt"]').forEach(cb => {
    cb.checked = set.has(cb.value);
  });
  // label nad przyciskami (jeÅ›li masz #catLive)
  if (labelText) document.getElementById("catLive").textContent = `Kategoria: ${labelText}`;
}

  // ---- ODBIÃ“R ZDARZEÅƒ Z SERWERA ----
  socket.on("joined", data => {
    document.getElementById("status").innerText = data.msg;
  });

  socket.on("info", data => {
    const msg = data.msg || "";
    document.getElementById("status").innerText = msg;

    // PrzeÅ‚Ä…cz ukÅ‚ad na podstawie komunikatÃ³w
    if (msg.startsWith("Gra rozpoczÄ™ta!")) {
      showAfterStart();
    } else if (msg.startsWith("Nowa runda!")) {
      showAfterStart();
    } else if (msg.toLowerCase().includes("zresetowana")) {
      showBeforeStart();
    }
  });

  socket.on("error_msg", data => { alert(data.msg); });


  socket.on("role", data => {
    const { category, secret, runda } = data;
    if (secret) {
      document.getElementById("role").innerText =
        `Runda ${runda}\nâœ… Gracz\nKategoria: ${category}\nHasÅ‚o: ${secret}`;
    } else {
      document.getElementById("role").innerText =
        `Runda ${runda}\nðŸ•µï¸â€â™‚ï¸ SZPIEG\nKategoria: ${category}`;
    }
    // na wszelki wypadek (gdyby info przyszÅ‚o pÃ³Åºniej)
    showAfterStart();
  });

  socket.on("timer", data => {
    const t = data.time;
    document.getElementById("timer").innerText = (t === "" || t == null) ? "" : `â³ ${t}s`;
  });
socket.on("timer_update", d => {
  const el = document.getElementById("timerSec");
  if (el) el.value = d.seconds;
});

  socket.on("paused", data => {
    document.getElementById("status").innerText =(data.msg || "");
  });

socket.on("clear", () => {
  document.getElementById("role").innerText = "";
  document.getElementById("timer").innerText = "";
  document.getElementById("status").innerText = "Oczekiwanie...";
  showBeforeStart();

  // ðŸ‘‡ reset wszystkich checkboxÃ³w kategorii
  document.querySelectorAll('input[name="catOpt"]').forEach(cb => {
    cb.checked = false;
  });

  console.log("[RESET] Odznaczono wszystkie kategorie po restarcie");
});




socket.on("boom", data => {

  if (navigator.vibrate)
   navigator.vibrate(900/2)
 document.body.classList.add("boomFX");
  setTimeout(() => {
    document.body.classList.remove("boomFX");
  }, 3000); // wraca do normalnego
})
socket.on("end", data => {

  if (navigator.vibrate)
   navigator.vibrate(900/2)
 document.body.classList.add("end");
  setTimeout(() => {
    document.body.classList.remove("end");
  }, 1500);
})

// toggle panelu kategorii
const picker = document.getElementById('catPicker');
const toggleBtn = document.getElementById('toggleCats');

toggleBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  picker.classList.toggle('open');
});

// zamknij klikniÄ™ciem poza panelem
document.addEventListener('click', (e) => {
  if (picker.classList.contains('open') &&
      !picker.contains(e.target) &&
      e.target !== toggleBtn) {
    picker.classList.remove('open');
  }
});

// zamknij ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') picker.classList.remove('open');
});

// jeÅ›li po starcie gry chcesz schowaÄ‡ panel:
socket.on("info2", data => {
  const host = data.host || "â€”";
  document.getElementById("hostInfo").textContent = `Host: ${host}`;
});

</script>

</html>
